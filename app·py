# app.py - å–è´§ç™»è®°åŠ©æ‰‹
import os
from datetime import datetime
from openpyxl import load_workbook, Workbook

EXCEL_FILE = "å–è´§ç™»è®°.xlsx"
SHEET_NAME = "Sheet1"

def init_excel():
    if not os.path.exists(EXCEL_FILE):
        wb = Workbook()
        ws = wb.active
        ws.title = SHEET_NAME
        headers = [
            "æ—¥æœŸ", "è´§å", "å…‹é‡", "æˆæœ¬", "æˆæœ¬æ€»ä»·",
            "å¹³å°", "è´§æº", "å–ä»·", "é€€æ¬¾å‰åˆ©æ¶¦", "é€€æ¬¾é‡‘é¢", "é€€æ¬¾ååˆ©æ¶¦"
        ]
        ws.append(headers)
        wb.save(EXCEL_FILE)

def get_today():
    return datetime.now().strftime("%Yå¹´%mæœˆ%dæ—¥")

def add_record():
    print("\nã€æ–°å¢é”€å”®è®°å½•ã€‘")
    try:
        goods = input("è¯·è¾“å…¥è´§å: ").strip()
        weight = float(input("è¯·è¾“å…¥å…‹é‡: "))
        cost = float(input("è¯·è¾“å…¥æˆæœ¬: "))
        source = input("è¯·è¾“å…¥è´§æº: ").strip()
        sell_price = float(input("è¯·è¾“å…¥å–ä»·: "))
    except ValueError:
        print("âŒ è¾“å…¥é”™è¯¯ï¼")
        return

    total_cost = weight * cost
    profit_before = sell_price - cost

    wb = load_workbook(EXCEL_FILE)
    ws = wb[SHEET_NAME]
    ws.append([
        get_today(), goods, weight, cost, total_cost,
        "æŠ–éŸ³", source, sell_price, profit_before,
        "", profit_before
    ])
    wb.save(EXCEL_FILE)
    print("âœ… è®°å½•å·²æ·»åŠ ï¼")

def search_records(criteria):
    wb = load_workbook(EXCEL_FILE)
    ws = wb[SHEET_NAME]
    matches = []
    for row_idx in range(2, ws.max_row + 1):
        data = [ws.cell(row=row_idx, column=col).value for col in range(1, 12)]
        if (data[1] == criteria["è´§å"] and data[2] == criteria["å…‹é‡"] and
            data[3] == criteria["æˆæœ¬"] and data[6] == criteria["è´§æº"] and
            data[7] == criteria["å–ä»·"]):
            matches.append((row_idx, data))
    return matches

def process_refund():
    print("\nã€å¤„ç†é€€æ¬¾ã€‘")
    try:
        goods = input("è´§å: ").strip()
        weight = float(input("å…‹é‡: "))
        cost = float(input("æˆæœ¬: "))
        source = input("è´§æº: ").strip()
        sell_price = float(input("å–ä»·: "))
    except ValueError:
        print("âŒ æ•°å­—æ ¼å¼é”™è¯¯ï¼")
        return

    criteria = {"è´§å": goods, "å…‹é‡": weight, "æˆæœ¬": cost, "è´§æº": source, "å–ä»·": sell_price}
    matches = search_records(criteria)

    if not matches:
        print("âŒ æœªæ‰¾åˆ°è®°å½•")
        return

    if len(matches) == 1:
        row_num = matches[0][0]
        print(f"âœ… æ‰¾åˆ°è®°å½•ï¼Œè¡Œå·: {row_num}")
    else:
        print(f"ğŸ” æ‰¾åˆ° {len(matches)} æ¡ï¼Œè¯·é€‰æ‹©ï¼š")
        for i, (r, d) in enumerate(matches): print(f"  {i+1}. è¡Œ{r} | {d[1]} | å–ä»·:{d[7]}")
        try:
            choice = int(input("é€‰åºå·: ")) - 1
            if 0 <= choice < len(matches): row_num = matches[choice][0]
            else: print("âŒ æ— æ•ˆ"); return
        except: print("âŒ è¾“å…¥æ•°å­—"); return

    try:
        refund = float(input("é€€æ¬¾é‡‘é¢: "))
    except: print("âŒ é‡‘é¢å¿…é¡»æ˜¯æ•°å­—"); return

    wb = load_workbook(EXCEL_FILE)
    ws = wb[SHEET_NAME]
    sell_val = ws.cell(row_num, 8).value
    cost_val = ws.cell(row_num, 4).value
    ws.cell(row_num, 10, refund)
    ws.cell(row_num, 11, 0 if refund >= sell_val else sell_val - cost_val)
    wb.save(EXCEL_FILE)
    print("âœ… é€€æ¬¾æ›´æ–°å®Œæˆï¼")

def main():
    if not os.path.exists(EXCEL_FILE): init_excel()
    while True:
        print("\nğŸ“¦ã€Œå–è´§ç™»è®°åŠ©æ‰‹ã€")
        print("1ï¸âƒ£ æ–°å¢è®°å½•  2ï¸âƒ£ å¤„ç†é€€æ¬¾  3ï¸âƒ£ é€€å‡º")
        choice = input("è¯·é€‰æ‹©: ").strip()
        if choice == "1": add_record()
        elif choice == "2": process_refund()
        elif choice == "3": print("ğŸ‘‹"); break
        else: print("âš ï¸ é€‰1/2/3")

if __name__ == "__main__":
    main()
